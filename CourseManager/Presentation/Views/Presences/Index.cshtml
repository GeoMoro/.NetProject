@using Business.ServicesInterfaces
@model IEnumerable<Presence>
@inject IPresenceService Service
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@{
    ViewData["Title"] = "Index";
}

<h2>Presences</h2>

@if (User.IsInRole("Assistant") || User.IsInRole("Owner"))
{
    <p>
        <a class="btn btn-default" asp-action="CreateFaction">Create Faction</a>
    </p>
}
else
{
    <p>
        <a class="btn btn-default" asp-action="MarkAsPresent">Mark as present</a>
    </p>
}

<table class="table">
    <thead>
    <tr>
        <th>
            @Html.DisplayNameFor(model => model.Name)
        </th>
        <th>
            Informations
        </th>
    </tr>
    </thead>
    <tbody>
    @foreach (var item in Model)
    {
        var value = Guid.NewGuid();
        <tr>
            <td>
                <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#@value">@item.Name</button>
            </td>

            <td>
                <div id="@value" class="collapse">
                    <table class="table">
                        <tr>
                            @{
                                var space = "---------";
                                var numberOfStudents = Service.GetUsersByFactionId(item.Id);
                                var userList = Service.GetUsersByFactionId(item.Id).Select(index => index.Id).ToList();

                                <th>
                                    @Html.DisplayFor(modelItem => space)
                                </th>

                                for (var index = 1; index <= 7; ++index)
                                {
                                    var numberOfLaboratories = 0;

                                    foreach (var givenUser in userList)
                                    {
                                        numberOfLaboratories += Service.GetAllAttendances().Count(att => att.UserId == givenUser);
                                    }
                                    
                                    var pastLaboratories = numberOfLaboratories / numberOfStudents.Count;
                                    var pass = false;

                                    <th>
                                        @{
                                            var change = numberOfStudents.FirstOrDefault().CanMarkAsPresent;

                                            if (index - pastLaboratories < 0)
                                            {
                                                <button class="btn btn-default">Finished</button>
                                            }
                                            else if (index - pastLaboratories == 0)
                                            {
                                                if (change)
                                                {
                                                    if (User.IsInRole("Assistant") || User.IsInRole("Owner"))
                                                    {
                                                        using (Html.BeginForm("StopPresence", "Presences", new {factionId = item.Id}, FormMethod.Post, null, new {}))
                                                        {
                                                            <button class="btn btn-default">Stop presence</button>
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    <button class="btn btn-default">Finished</button>
                                                }
                                            }
                                            else
                                            {
                                                if (User.IsInRole("Assistant") || User.IsInRole("Owner"))
                                                {
                                                    if (change && pass)
                                                    {
                                                        using (Html.BeginForm("StopPresence", "Presences", new {factionId = item.Id}, FormMethod.Post, null, new {}))
                                                        {
                                                            <button class="btn btn-default">Stop presence</button>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        using (Html.BeginForm("StartPresence", "Presences", new {factionId = item.Id, labValue = index}, FormMethod.Post, null, new {}))
                                                        {
                                                            <button class="btn btn-default">Start presence</button>
                                                        }

                                                        pass = true;
                                                    }
                                                }
                                            }
                                        }

                                        Week @Html.DisplayFor(modelItem => index)
                                    </th>
                                        
                                }

                            }
                        </tr>
                        <tr>
                            @{
                                var presence = "P|";
                                var lab = "L|";
                                var kata = "K|";
                                var actions = "Actions";
                                var stud = "Student";
                                <th>
                                    @Html.DisplayFor(modelItem => stud)
                                </th>

                                for (var index = 1; index <= 7; ++index)
                                {
                                    <th>
                                        @Html.DisplayFor(modelItem => presence)
                                        @Html.DisplayFor(modelItem => lab)
                                        @Html.DisplayFor(modelItem => kata)

                                        @if (User.IsInRole("Assistant") || User.IsInRole("Owner"))
                                        {
                                            @Html.DisplayFor(modelItem => actions)
                                        }
                                    </th>
                                }
                            }
                        </tr>
                        @foreach (var student in item.Students)
                        {
                            <tr>
                                @{
                                    var currentUser = UserManager.Users.SingleOrDefault(user => user.Id == student.Id);
                                    var displayName = currentUser.FirstName + currentUser.LastName;
                                    <th>
                                        @Html.DisplayFor(modelItem => displayName)
                                    </th>

                                    foreach (var activ in student.Attendance)
                                    {
                                        <td>
                                            @Html.DisplayFor(modelItem => activ.Presence)
                                            @Html.DisplayFor(modelItem => activ.LaboratoryMark)
                                            @Html.DisplayFor(modelItem => activ.KataMark)

                                            @if (User.IsInRole("Assistant") || User.IsInRole("Owner"))
                                            {
                                                @Html.ActionLink("Edit", "UpdatePresence", "Presences", new { attendanceId = activ.Id }, null)
                                            }
                                        </td>
                                    }
                                }
                            </tr>
                        }
                    </table>
                </div>
            </td>

            <td>
                @if (User.IsInRole("Assistant") || User.IsInRole("Owner"))
                {
                    <a class="btn btn-default" asp-action="Delete" asp-route-id="@item.Id">Delete</a>
                }
            </td>
        </tr>
    }
    </tbody>
</table>